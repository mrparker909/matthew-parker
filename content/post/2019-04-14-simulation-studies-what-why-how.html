---
title: 'Simulation Studies: What? Why? How?'
author: Matthew Parker
date: '2019-05-13'
slug: simulation-studies-what-why-how
categories:
  - R
  - Probability
  - Statistics
tags:
  - simulations
  - parameter properties
  - randomization
  - bias
  - variance
header:
  caption: ''
  image: ''
---



<p>Sometimes you know more about modelling the population you are studying than you do about the parameters feeding your models. Suppose your population has unknown birth rate <span class="math inline">\(\gamma\)</span>, and survival probability <span class="math inline">\(\omega\)</span>. You have a model incorporating these two parameters. You can use your model and data observations to estimate <span class="math inline">\(\gamma\)</span> and <span class="math inline">\(\omega\)</span>. But how precise are these estimates? Are they biased? How many observations should you collect? Simulation studies are here to help answer those questions!</p>
<div id="what-is-a-simulation-study" class="section level1">
<h1>What is a simulation study</h1>
<p>A simulation study is a method of investigating the properties of a statistical model, usually before you collect data on your population. It is useful for experimental design (choosing an appropriate sample size), and for better understanding the limitations of your model through parameter bias and variability.</p>
<p>There are four key components to a simulation study</p>
<ol style="list-style-type: decimal">
<li>A Statistical Model</li>
<li>Simulation Scope</li>
<li>Generating Randomized Populations</li>
<li>Parameter Estimation</li>
</ol>
<div id="a-statistical-model" class="section level2">
<h2>1. A Statistical Model</h2>
<p>In general, to perform a simulation study, you need a parametric model. A parametric model is a function of your data and your parameters, generally a probability function or a likelihood. For example, if you have a set of <span class="math inline">\(n\)</span> observations <span class="math inline">\(\vec{x}=\{x_1, x_2, \cdots, x_n\}\)</span>, with a single population paramter <span class="math inline">\(\theta\)</span>, then the form of your parametric model would be:</p>
<p><span class="math display">\[
  f(\theta \mid \vec{x})
\]</span></p>
<p>Where <span class="math inline">\(f\)</span> is a function of the population parameter, given a set of observed data. At this point, we have a parametric model, and a parameter of interest. However we have not yet performed an experiment to obtain <span class="math inline">\(\vec{x}\)</span>. We instead want to investigate <span class="math inline">\(\theta\)</span> first, to help us with planning the experiment. This is done using randomization.</p>
</div>
<div id="simulation-scope" class="section level2">
<h2>2. Simulation Scope</h2>
<p>The scope of your simulation is the set of limitations and boundaries which you are exploring. For example, you might only care about simulations for a particular sample size <span class="math inline">\(n\)</span>. Or you may need to compare simulation results for a range of values of <span class="math inline">\(n\)</span>. Likewise for your parameter of interest <span class="math inline">\(\theta\)</span>, you may want to generate random values of <span class="math inline">\(\theta\)</span> from a prior distribution, or you may have a range of values incrementing linearly. Regardless, you need to settle on the scope for your particular simulation study.</p>
</div>
<div id="generating-randomized-populations" class="section level2">
<h2>3. Generating Randomized Populations</h2>
<p>What generating scheme you choose will depend on what your goal is (and on your scope). In general, you need to decide what values are fixed, what values are random, and how to randomize those values. These choices are NOT arbitrary, and you should always discuss these choices and the potential ramifications of those choices.</p>
<p>What will be randomized every time is the “observed” sample. Of course this is not a truly observed sample, but a generated sample. These samples are generated for each combination of <span class="math inline">\(n\)</span> and <span class="math inline">\(\theta\)</span>, using the statistical model <span class="math inline">\(f(\theta \mid \vec{x})\)</span>.</p>
<p>Finally you need to decide on a simulation study size <span class="math inline">\(M\)</span>, how many simulated observations you will have for each set of values (in this case, each choice of <span class="math inline">\(n\)</span> and <span class="math inline">\(\theta\)</span>). A reasonable simulation size might be <span class="math inline">\(M=1000\)</span>.</p>
</div>
<div id="parameter-estimation" class="section level2">
<h2>4. Parameter Estimation</h2>
<p>Let’s assume that you have chosen <span class="math inline">\(n\)</span> to be from the set <span class="math inline">\(\{n_1, n_2, \cdots, n_{max}\}\)</span>, and <span class="math inline">\(\theta\)</span> from the set <span class="math inline">\(\{\theta_1, \theta_2, \cdots, \theta_{max}\}\)</span>.</p>
<p>You have generated a whole bunch of simulated observations, for which you can get parameter estimates:</p>
<div id="example-simulation-algorithm" class="section level3">
<h3>Example Simulation Algorithm</h3>
<ul>
<li>for <span class="math inline">\(n\)</span> in <span class="math inline">\(\{n_1, n_2, \cdots, n_{max}\}\)</span>:
<ul>
<li>for <span class="math inline">\(\theta\)</span> in <span class="math inline">\(\{\theta_1, \theta_2, \cdots, \theta_{max}\}\)</span>:
<ul>
<li>for <span class="math inline">\(m\)</span> in <span class="math inline">\(1,2,3,\cdots,M\)</span>:
<ul>
<li>generate a randomized sample <span class="math inline">\(x_{n,\theta,m}\)</span></li>
<li>perform model fitting (for example maximum likelihood estimation) to obtain <span class="math inline">\(M\)</span> parameter estimates <span class="math inline">\(\hat{\theta}_{n,\theta,m}\)</span> from the sample.</li>
</ul></li>
</ul></li>
</ul></li>
</ul>
<p>Now for each <span class="math inline">\(n\)</span> and each <span class="math inline">\(\theta\)</span>, you have <span class="math inline">\(M\)</span> estimates for your parameter.</p>
<p>You can, for example, calculate the variance of <span class="math inline">\(\hat{\theta}_{n,\theta}\)</span> for each <span class="math inline">\(n\)</span> and <span class="math inline">\(\theta\)</span>: <span class="math inline">\(\displaystyle Var[\hat{\theta}_{n,\theta}]= \frac{1}{M-1} \sum_{m=1}^{M} (\hat{\theta}_{n,\theta,m} - \theta)^2\)</span>. Or you can calculate the bias: <span class="math inline">\(\displaystyle E[\hat\theta_{n,\theta}]-\theta=\frac{1}{M}\sum_{m=1}^{M}\hat{\theta}_{n,\theta,m} -\theta\)</span></p>
</div>
</div>
</div>
<div id="whenwhy-should-you-use-a-simulation-study" class="section level1">
<h1>When/Why should you use a simulation study</h1>
<p>Here are some possible questions you might be investigating:</p>
<ul>
<li>how large should our sample size <span class="math inline">\(n\)</span> be to control the parameter variance?</li>
<li>is our model robust against small deviations to the parametric model?</li>
<li>is the parameter estimate biased?</li>
<li>what is the variance of the estimated parameter under particular conditions?</li>
<li>what is the empirical distribution of the estimated parameter?</li>
</ul>
<p>Sometimes these questions are better answered through mathematical statistics methods, where derivations can provide definitive answers. However all too often, the models involved are far too complex for those approaches. In that case we can use simulations to gain insight.</p>
</div>
<div id="how-to-perform-a-simulation-study-in-r" class="section level1">
<h1>How to perform a simulation study (in R)</h1>
<p>Let us consider a very simple illustrative example. We have a Poisson parametric model:</p>
<p><span class="math display">\[
   f(\theta\mid\vec{x}) = \prod_{i=1}^n Poisson(\theta; x_i)
\]</span></p>
<p>Given this model, we want to choose <span class="math inline">\(n\)</span> so that when estimating <span class="math inline">\(\theta\)</span>, we have <span class="math inline">\(Var[\hat\theta] &lt; 0.01\times E[\hat\theta]\)</span>. For simplicity we will consider <span class="math inline">\(\theta\)</span> to be a constant, <span class="math inline">\(\theta=7\)</span>.</p>
<pre class="r"><code># set random number seed for reproducible results
set.seed(1)

# set theta
theta &lt;- 7

# set simulation options
n_options &lt;- seq(10, 100, 10)
M         &lt;- 100

# empty array to hold our simulation results
theta_hat &lt;- array(dim=c(length(n_options),M))

# negative log likelihood function
nLL &lt;- function(par, x) {
  -1*sum(dpois(x, lambda = par, log=TRUE))
}

# run simulation
for(n in n_options) {
  n_index &lt;- which(n_options==n)
  for(m in 1:M) {
    # generate sample of size n
    samp &lt;- rpois(n = n, lambda = theta)
  
    # calculate theta estimate using maximum likelihood estimation
    theta_hat[n_index,m] &lt;- optim(par = c(5), 
                                  fn = nLL, 
                                  method = &quot;BFGS&quot;, 
                                  x=samp)$par
  }
}</code></pre>
<p>So what does theta_hat look like? Let’s look at the first row, corresponding to <span class="math inline">\(n_1=10\)</span>:</p>
<pre class="r"><code>theta_hat[1,]</code></pre>
<pre><code>##   [1] 7.400016 7.700024 6.299999 7.100010 7.500019 6.199999 7.200012
##   [8] 8.200033 6.100000 7.400016 7.600021 6.600003 7.300014 7.300014
##  [15] 7.000008 6.000000 6.900007 8.600036 7.700024 7.000008 5.800000
##  [22] 9.000032 6.399998 6.600003 6.700004 7.500019 6.299999 5.300853
##  [29] 5.100037 6.499996 6.900007 6.900007 8.900034 7.100010 7.000008
##  [36] 7.400016 6.800005 6.800005 7.900028 6.000000 8.200033 8.300034
##  [43] 7.200012 7.000008 5.800000 7.000008 6.100000 7.300014 6.900007
##  [50] 6.100000 8.200033 6.900007 8.800035 5.300853 7.800026 7.000008
##  [57] 7.600021 6.800005 7.200012 7.300014 8.700036 6.600003 7.100010
##  [64] 6.700004 7.900028 7.200012 6.900007 6.499996 6.800005 7.100010
##  [71] 8.100032 6.100000 6.499996 6.199999 6.600003 6.900007 7.000008
##  [78] 8.000030 7.200012 6.700004 7.400016 7.800026 6.900007 8.300034
##  [85] 6.499996 6.700004 5.300853 7.700024 8.500036 3.600003 5.000000
##  [92] 6.499996 7.900028 8.100032 7.500019 6.299999 7.400016 7.300014
##  [99] 7.900028 5.900000</code></pre>
<p>So for <span class="math inline">\(n_1=10\)</span>, we have <span class="math inline">\(M=100\)</span> estimates for <span class="math inline">\(\theta_{n_1}\)</span>. For this one sample size, the variance and the bias are calculated like this:</p>
<pre class="r"><code># variance
var(theta_hat[1,])</code></pre>
<pre><code>## [1] 0.8216046</code></pre>
<pre class="r"><code># bias
mean(theta_hat[1,]) - theta</code></pre>
<pre><code>## [1] 0.02103784</code></pre>
<p>But we can also calculate these for each value of <span class="math inline">\(n\)</span>:</p>
<pre class="r"><code>variances &lt;- apply(theta_hat, 1, var)
biases    &lt;- apply(theta_hat, 1, function(x){mean(x)-theta})
means     &lt;- apply(theta_hat, 1, mean)

data.frame(n = n_options, Mean=means, Var=variances, Bias=biases, Condition=variances&lt;0.01*means)</code></pre>
<pre><code>##      n     Mean        Var         Bias Condition
## 1   10 7.021038 0.82160461  0.021037843     FALSE
## 2   20 6.913494 0.32152224 -0.086506221     FALSE
## 3   30 7.053000 0.23050722  0.053000009     FALSE
## 4   40 6.998500 0.18650046 -0.001499959     FALSE
## 5   50 6.981009 0.14446070 -0.018991422     FALSE
## 6   60 7.014499 0.11029512  0.014498941     FALSE
## 7   70 6.980999 0.10384226 -0.019000564     FALSE
## 8   80 7.004875 0.07404323  0.004875026     FALSE
## 9   90 7.011333 0.06727766  0.011333379      TRUE
## 10 100 7.004000 0.06253535  0.004000056      TRUE</code></pre>
<p>So in order to control the variance under the condition that the variance be less than 1% of the expected value, we would choose <span class="math inline">\(n\)</span> to be at least 90. The precision of our simulation study is determined by the choice of <span class="math inline">\(M\)</span>, and so larger values of <span class="math inline">\(M\)</span> are much preferred and can be very influential to the results if not chosen to be large enough.</p>
<p>We chose <span class="math inline">\(M=100\)</span>, for simplicity; however <span class="math inline">\(M=1000\)</span>, or even larger, is likely to give better results. When possible, the simulation should be run with several increasing values of <span class="math inline">\(M\)</span> in order to determine whether the results are stable.</p>
</div>
